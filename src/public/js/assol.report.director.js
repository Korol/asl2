$(document).ready(function(){$.ReportDirector={Init:function(){this.InitActions();this.InitTemplate();this.InitDynamicData()},InitActions:function(){function b(a,c,d){var b=c;switch(d||"number"){case "number":c=0<c?c:"";break;case "decimal":c=0<c?c:""}if(null!=$(a).contentEditable)$(a).attr("contentEditable",isEdit);else{c=$("<input/>",{type:"text",min:0,value:c}).attr("last-value",b);switch(d||"number"){case "number":c.numeric();break;case "decimal":c.numeric(),c.keydown(function(a){if("188"==a.keyCode||
"188"==a.charCode||"110"==a.keyCode||"110"==a.charCode)a.preventDefault(),a=$(a.target),0<a.val().indexOf(".")||a.val(a.val()+".")})}$(a).html(c);c.focus()}}$(document).on("click","#ReportOverallSalary_data a.confirm",function(){var a=$(this).closest("td"),c={SiteID:$("#overlaySalarySite").find("input:radio:checked").val(),employee:$(this).closest("tr").attr("id-employee"),year:$("#overlay-salary-year").data("DateTimePicker").date().year(),month:$("#overlay-salary-month").val()};$.post(BaseUrl+"reports/overlay/salary/close",
c,function(c){c.status?(a.html("\u043f\u043e\u0434\u0442\u0432\u0435\u0440\u0436\u0434\u0435\u043d\u043e"),alert("\u0414\u0430\u043d\u043d\u044b\u0435 \u0443\u0441\u043f\u0435\u0448\u043d\u043e \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u044b \u0432 \u043e\u0431\u0449\u0443\u044e \u0442\u0430\u0431\u043b\u0438\u0446\u0443 \u0437/\u043f")):alert("\u041e\u0448\u0438\u0431\u043a\u0430: "+c.message)},"json")});$(document).on("click","#overlaySalarySite input:radio",function(a){$.ReportDirector.ReloadReportOverallSalary($(a.target).val())});
$(document).on("click","#ReportOverallSalary_data>tbody>tr>td[type]>div",function(){var a=$(this).parent().hasClass("decimal")?"decimal":"number";b($(this).parent(),$(this).html(),a)});$(document).on("focusout","#ReportOverallSalary_data td[type]>input",function(){function a(a){d.html($("<div/>",{text:a}))}function c(c){c.status?(a(g),c=d.attr("original")||0,g!=c?d.addClass("editable-cell"):d.removeClass("editable-cell"),c=d.closest("tr").find(".status"),"\u043f\u043e\u0434\u0442\u0432\u0435\u0440\u0436\u0434\u0435\u043d\u043e"==
c.html()&&c.html('<a href="#" class="confirm">\u043f\u043e\u0434\u0442\u0432\u0435\u0440\u0434\u0438\u0442\u044c</a>'),$.ReportDirector.RefreshReportOverallSalaryDataSummary()):(a(f),alert("\u041e\u0448\u0438\u0431\u043a\u0430: "+c.message))}var d=$(this).parent(),b=d.hasClass("decimal"),f=b?parseFloat($(this).attr("last-value")||0):parseInt($(this).attr("last-value")||0),g=b?parseFloat($(this).val()||0):parseInt($(this).val()||0);if(f!=g){var b=$("#overlay-salary-year").data("DateTimePicker").date().year(),
h=$("#overlay-salary-month").val(),k=d.attr("type"),b={SiteID:$("#overlaySalarySite").find("input:radio:checked").val(),idEmployee:d.closest("tr").attr("id-employee"),year:b,month:h,type:k,value:g};$.post(BaseUrl+"reports/overlay/salary/save",b,c,"json")}else a(f)});$(document).on("click","#ReportGeneralSalary_data thead td[id-site]>div",function(){b($(this).parent(),$(this).html())});$(document).on("focusout","#ReportGeneralSalary_data thead td[id-site]>input",function(){function a(a){b.html($("<div/>",
{text:a}))}function c(c){c.status?(a(g),$.ReportDirector.ReloadReportGeneralSalaryDataSummary()):(a(f),alert("\u041e\u0448\u0438\u0431\u043a\u0430: "+c.message))}var b=$(this).parent(),e=b.hasClass("decimal"),f=e?parseFloat($(this).attr("last-value")||0):parseInt($(this).attr("last-value")||0),g=e?parseFloat($(this).val()||0):parseInt($(this).val()||0);if(f!=g){var e=$("#general-salary-year").data("DateTimePicker").date().year(),h=$("#general-salary-month").val(),e={idEmployee:b.closest("tr").attr("id-employee"),
idSite:b.attr("id-site"),year:e,month:h,value:g};$.post(BaseUrl+"reports/general/salary/save",e,c,"json")}else a(f)});$(document).on("click","#ReportGeneralSalary_data .is-repay-tooltip .yes",function(){var a=$(this).closest("td"),c={idRecord:a.find("div[id-record]").attr("id-record"),paid:1};$.post(BaseUrl+"reports/general/salary/paid",c,function(c){c.status?a.addClass("repay"):alert("\u041e\u0448\u0438\u0431\u043a\u0430: "+c.message)},"json")});$(document).on("click","#ReportGeneralSalary_data .is-repay-tooltip .no",
function(){var a=$(this).closest("td"),c={idRecord:a.find("div[id-record]").attr("id-record"),paid:0};$.post(BaseUrl+"reports/general/salary/paid",c,function(c){c.status?a.removeClass("repay"):alert("\u041e\u0448\u0438\u0431\u043a\u0430: "+c.message)},"json")});$(document).on("click","#overallAllocationSite input:radio",function(a){$.ReportDirector.ReloadReportOverallAllocation($(a.target).val())})},InitDynamicData:function(){},InitTemplate:function(){$("#reportGeneralOfCustomersTemplate").template("reportGeneralOfCustomersTemplate");
$("#reportGeneralOfCustomers_fixedWrapBody_Template").template("reportGeneralOfCustomers_fixedWrapBody_Template");$("#reportGeneralOfCustomers_total_Template").template("reportGeneralOfCustomers_total_Template");$("#reportOverallSalaryTemplate").template("reportOverallSalaryTemplate");$("#reportGeneralSalarySumTemplate").template("reportGeneralSalarySumTemplate");$("#reportOverallAllocation_Template").template("reportOverallAllocation_Template")},RefreshReportGeneralOfCustomersDate:function(b){var a=
$("#general-customers-year"),c=$("#general-customers-month"),d=$("#general-customers-day");b=moment([b||a.data("DateTimePicker").date().year(),c.val()]).endOf("month").date();d.empty();d.append($("<option/>",{value:0,text:"\u0437\u0430 \u043c\u0435\u0441\u044f\u0446"}));for(a=1;a<=b;a++)d.append($("<option/>",{value:a,text:a}));c.val()==moment().month()&&d.find("[value='"+moment().date()+"']").attr("selected","selected");$.ReportDirector.ReloadReportGeneralOfCustomersData()},RefreshReportGeneralOfCustomersDataSummary:function(){var b=
$("#ReportGeneralOfCustomers_data"),a=$("#ReportGeneralOfCustomers_total"),c=$("#ReportGeneralOfCustomers_fixedWrapBody");console.log("RefreshReportGeneralOfCustomersDataSummary");$(b).find("tfoot td div").html(0);$(a).find("tbody td, tfoot td").html(0);$(c).find("tbody td, tfoot td").html(0);$(b).find("tbody .mail").each(function(){var a=$(this).attr("id-site"),a=$("#gc_foot_mail_"+a);a.html(parseFloat(a.html())+parseFloat($(this).find("div").html()));a=$(this).attr("id-customer");a=$("#gc_total_"+
a).find("td:eq(0)");a.html(parseFloat(a.html())+parseFloat($(this).find("div").html()))});$(b).find("tbody .chat").each(function(){var a=$(this).attr("id-site"),a=$("#gc_foot_chat_"+a);a.html(parseFloat(a.html())+parseFloat($(this).find("div").html()));var a=$(this).attr("id-customer"),c=$("#gc_total_"+a),b=c.find("td:eq(0)"),d=c.find("td:eq(1)"),c=c.find("td:eq(2)");d.html(parseFloat(d.html())+parseFloat($(this).find("div").html()));c.html(parseFloat(d.html())+parseFloat(b.html()));$("#gc_slide_total_"+
a).find("td").html(c.html())});var b=$(a).find("tfoot>tr"),d=b.find("td:eq(0)"),e=b.find("td:eq(1)"),f=b.find("td:eq(2)");$(a).find("tbody>tr").each(function(){d.html(parseFloat(d.html())+parseFloat($(this).find("td:eq(0)").html()));e.html(parseFloat(e.html())+parseFloat($(this).find("td:eq(1)").html()));f.html(parseFloat(f.html())+parseFloat($(this).find("td:eq(2)").html()))});$(c).find("tfoot>tr>td").html(f.html())},ReloadReportOverallSalary:function(b){b=b||$("#overlaySalarySite").find("input:radio:checked").val();
var a=$("#ReportOverallSalary_data").find(">tbody");a.empty();b={SiteID:b,year:$("#overlay-salary-year").data("DateTimePicker").date().year(),month:$("#overlay-salary-month").val()};$.post(BaseUrl+"reports/overlay/salary/data",b,function(c){c.status?($.tmpl("reportOverallSalaryTemplate",c.records).appendTo(a),$.ReportDirector.RefreshReportOverallSalaryDataSummary()):alert("\u041e\u0448\u0438\u0431\u043a\u0430 \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u044f \u0434\u0430\u043d\u043d\u044b\u0445")},
"json")},RefreshReportOverallSalaryDataSummary:function(){var b=$("#ReportOverallSalary_data");$(b).find("tr").find("td:eq(9)").html(0);$(b).find("tbody>tr").each(function(){var a=parseFloat($(this).find("td:eq(2) div").html())||0,b=parseFloat($(this).find("td:eq(4) div").html())||0,e=parseFloat($(this).find("td:eq(6) div").html())||0,f=parseFloat($(this).find("td:eq(8) div").html())||0;$(this).find("td:eq(9)").html((a+b+e+f).toFixed(2))});var a=$(b).find("tfoot td:eq(9)");$(b).find("tbody>tr").find("td:eq(9)").each(function(){var c=
parseFloat($(this).html())||0,b=parseFloat(a.html())||0;a.html((b+c).toFixed(2))})},ReloadReportGeneralSalary:function(){$("#ReportGeneralSalary_data").find("thead tr[id-employee] td[id-site] div").empty();$("#ReportGeneralSalary_data").find("tbody tr[id-employee] td[id-site]").empty().removeClass("repay");var b={year:$("#general-salary-year").data("DateTimePicker").date().year(),month:$("#general-salary-month").val()};$.post(BaseUrl+"reports/general/salary/data",b,function(a){a.status?($("#ReportGeneralSalary_data tbody tr[id-employee] td[id-site]").html("-"),
$(a.cross).each(function(a,b){$('#ReportGeneralSalary_data tbody tr[id-employee="'+b.EmployeeID+'"] td[id-site="'+b.SiteID+'"]').html("")}),$(a.records).each(function(a,b){if(0<b.EmployeeID){var e='#ReportGeneralSalary_data tbody tr[id-employee="'+b.EmployeeID+'"] td[id-site="'+b.SiteID+'"]';1==b.paid&&$(e).closest("td").addClass("repay");$.tmpl("reportGeneralSalarySumTemplate",b).appendTo(e)}else $('#ReportGeneralSalary_data thead tr[id-employee="'+b.EmployeeID+'"] td[id-site="'+b.SiteID+'"]').find("div").html(b.value)}),
$.ReportDirector.ReloadReportGeneralSalaryDataSummary()):alert("\u041e\u0448\u0438\u0431\u043a\u0430 \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u044f \u0434\u0430\u043d\u043d\u044b\u0445")},"json")},ReloadReportGeneralSalaryDataSummary:function(){$(".total-salary-report-table thead td[id-site]").each(function(){var b=$(this).attr("id-site"),a=parseFloat($(this).find("div").html())||0;$('.total-salary-report-table tbody td[id-site="'+b+'"]').each(function(){a-=parseFloat($(this).find("div>a").html())||
0});$('.total-salary-report-table tfoot td[id-site="'+b+'"]').html(a.toFixed(2))})},ReloadReportGeneralOfCustomers:function(){$.ReportDirector.ReloadGeneralOfCustomersMeta()},ReloadReportOverallAllocation:function(b){b=b||$("#overallAllocationSite").find("input:radio:checked").val();var a=$("#ReportOverallAllocation_data").find(">tbody");a.empty();$("#ReportOverallNotAllocation_data").find("td").empty();$.post(BaseUrl+"reports/overall/allocation/data",{SiteID:b},function(c){c.status?($.tmpl("reportOverallAllocation_Template",
c.records).appendTo(a),$("#ReportOverallNotAllocation_data").find("td").html(c.records.freeAllSitesCustomers)):alert("\u041e\u0448\u0438\u0431\u043a\u0430 \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u044f \u0434\u0430\u043d\u043d\u044b\u0445")},"json")},ReloadGeneralOfCustomersMeta:function(b){b=void 0===b?!1:b;var a={year:$("#general-customers-year").data("DateTimePicker").date().year(),month:$("#general-customers-month").val(),day:$("#general-customers-day").val()};$("#ReportGeneralOfCustomers_data").empty();
$("#ReportGeneralOfCustomers_fixedWrapBody").find(">tbody").empty();$("#ReportGeneralOfCustomers_total").find(">tbody").empty();$.getJSON(BaseUrl+"reports/general/customers/meta",a,function(a){console.log(a.records);a.status&&($.tmpl("reportGeneralOfCustomersTemplate",a.records).appendTo("#ReportGeneralOfCustomers_data"),$.tmpl("reportGeneralOfCustomers_fixedWrapBody_Template",a.records.customers).appendTo("#ReportGeneralOfCustomers_fixedWrapBody>tbody"),$.tmpl("reportGeneralOfCustomers_total_Template",
a.records.customers).appendTo("#ReportGeneralOfCustomers_total>tbody"),b||$.ReportDirector.RefreshReportGeneralOfCustomersDate())})},ReloadReportGeneralOfCustomersData:function(){var b={year:$("#general-customers-year").data("DateTimePicker").date().year(),month:$("#general-customers-month").val(),day:$("#general-customers-day").val()};$.post(BaseUrl+"reports/general/customers/data",b,function(a){function b(a,c,f,g,h){a.addClass(c).attr("id-customer",f).attr("id-site",g).find("div").html(h||0)}$("#ReportGeneralOfCustomers_data").find(".mail div, .chat div").html(0);
$.each(a.records,function(a,e){var f=e.CustomerID+"_"+e.SiteID;b($("#gc_mail_"+f),"mail",e.CustomerID,e.SiteID,e.emails);b($("#gc_chat_"+f),"chat",e.CustomerID,e.SiteID,e.chat)});$.ReportDirector.RefreshReportGeneralOfCustomersDataSummary()},"json")}};$.ReportDirector.Init()});
