$(document).ready(function(){$.ReportDirector={Init:function(){this.InitActions();this.InitTemplate();this.InitDynamicData()},InitActions:function(){function b(d,c,a){var b=c;switch(a||"number"){case "number":c=0<c?c:"";break;case "decimal":c=0<c?c:""}if(null!=$(d).contentEditable)$(d).attr("contentEditable",isEdit);else{c=$("<input/>",{type:"text",min:0,value:c}).attr("last-value",b);switch(a||"number"){case "number":c.numeric();break;case "decimal":c.numeric(),c.keydown(function(a){if("188"==a.keyCode||
"188"==a.charCode||"110"==a.keyCode||"110"==a.charCode)a.preventDefault(),a=$(a.target),0<a.val().indexOf(".")||a.val(a.val()+".")})}$(d).html(c);c.focus()}}$(document).on("click","#ReportOverallSalary_data a.confirm",function(){var d=$(this).closest("td"),c={SiteID:$("#overlaySalarySite").find("input:radio:checked").val(),employee:$(this).closest("tr").attr("id-employee"),year:$("#overlay-salary-year").data("DateTimePicker").date().year(),month:$("#overlay-salary-month").val()};$.post(BaseUrl+"reports/overlay/salary/close",
c,function(a){a.status?(d.html("\u043f\u043e\u0434\u0442\u0432\u0435\u0440\u0436\u0434\u0435\u043d\u043e"),alert("\u0414\u0430\u043d\u043d\u044b\u0435 \u0443\u0441\u043f\u0435\u0448\u043d\u043e \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u044b \u0432 \u043e\u0431\u0449\u0443\u044e \u0442\u0430\u0431\u043b\u0438\u0446\u0443 \u0437/\u043f")):alert("\u041e\u0448\u0438\u0431\u043a\u0430: "+a.message)},"json")});$(document).on("click","#overlaySalarySite input:radio",function(d){$.ReportDirector.ReloadReportOverallSalary($(d.target).val())});
$(document).on("click","#ReportOverallSalary_data>tbody>tr>td[type]>div",function(){var d=$(this).parent().hasClass("decimal")?"decimal":"number";b($(this).parent(),$(this).html(),d)});$(document).on("focusout","#ReportOverallSalary_data td[type]>input",function(){function d(d){a.html($("<div/>",{text:d}))}function c(c){c.status?(d(f),c=a.attr("original")||0,f!=c?a.addClass("editable-cell"):a.removeClass("editable-cell"),c=a.closest("tr").find(".status"),"\u043f\u043e\u0434\u0442\u0432\u0435\u0440\u0436\u0434\u0435\u043d\u043e"==
c.html()&&c.html('<a href="#" class="confirm">\u043f\u043e\u0434\u0442\u0432\u0435\u0440\u0434\u0438\u0442\u044c</a>'),$.ReportDirector.RefreshReportOverallSalaryDataSummary()):(d(e),alert("\u041e\u0448\u0438\u0431\u043a\u0430: "+c.message))}var a=$(this).parent(),b=a.hasClass("decimal"),e=b?parseFloat($(this).attr("last-value")||0):parseInt($(this).attr("last-value")||0),f=b?parseFloat($(this).val()||0):parseInt($(this).val()||0);if(e!=f){var b=$("#overlay-salary-year").data("DateTimePicker").date().year(),
g=$("#overlay-salary-month").val(),k=a.attr("type"),b={SiteID:$("#overlaySalarySite").find("input:radio:checked").val(),idEmployee:a.closest("tr").attr("id-employee"),year:b,month:g,type:k,value:f};$.post(BaseUrl+"reports/overlay/salary/save",b,c,"json")}else d(e)});$(document).on("click","#ReportGeneralSalary_data thead td[id-site]>div",function(){b($(this).parent(),$(this).html())});$(document).on("focusout","#ReportGeneralSalary_data thead td[id-site]>input",function(){function d(c){a.html($("<div/>",
{text:c}))}function c(a){a.status?(d(f),$.ReportDirector.ReloadReportGeneralSalaryDataSummary()):(d(e),alert("\u041e\u0448\u0438\u0431\u043a\u0430: "+a.message))}var a=$(this).parent(),b=a.hasClass("decimal"),e=b?parseFloat($(this).attr("last-value")||0):parseInt($(this).attr("last-value")||0),f=b?parseFloat($(this).val()||0):parseInt($(this).val()||0);if(e!=f){var b=$("#general-salary-year").data("DateTimePicker").date().year(),g=$("#general-salary-month").val(),b={idEmployee:a.closest("tr").attr("id-employee"),
idSite:a.attr("id-site"),year:b,month:g,value:f};$.post(BaseUrl+"reports/general/salary/save",b,c,"json")}else d(e)});$(document).on("click","#ReportGeneralSalary_data .is-repay-tooltip .yes",function(){var d=$(this).closest("td"),c={idRecord:d.find("div[id-record]").attr("id-record"),paid:1};$.post(BaseUrl+"reports/general/salary/paid",c,function(a){a.status?d.addClass("repay"):alert("\u041e\u0448\u0438\u0431\u043a\u0430: "+a.message)},"json")});$(document).on("click","#ReportGeneralSalary_data .is-repay-tooltip .no",
function(){var d=$(this).closest("td"),c={idRecord:d.find("div[id-record]").attr("id-record"),paid:0};$.post(BaseUrl+"reports/general/salary/paid",c,function(a){a.status?d.removeClass("repay"):alert("\u041e\u0448\u0438\u0431\u043a\u0430: "+a.message)},"json")});$(document).on("click","#overallAllocationSite input:radio",function(d){$.ReportDirector.ReloadReportOverallAllocation($(d.target).val())})},InitDynamicData:function(){},InitTemplate:function(){$("#reportGeneralOfCustomersTemplate").template("reportGeneralOfCustomersTemplate");
$("#reportGeneralOfCustomers_fixedWrapBody_Template").template("reportGeneralOfCustomers_fixedWrapBody_Template");$("#reportGeneralOfCustomers_total_Template").template("reportGeneralOfCustomers_total_Template");$("#reportOverallSalaryTemplate").template("reportOverallSalaryTemplate");$("#reportGeneralSalarySumTemplate").template("reportGeneralSalarySumTemplate");$("#reportOverallAllocation_Template").template("reportOverallAllocation_Template")},RefreshReportGeneralOfCustomersDate:function(b){var d=
$("#general-customers-year"),c=$("#general-customers-month"),a=$("#general-customers-day");b=moment([b||d.data("DateTimePicker").date().year(),c.val()]).endOf("month").date();a.empty();a.append($("<option/>",{value:0,text:"\u0437\u0430 \u043c\u0435\u0441\u044f\u0446"}));for(d=1;d<=b;d++)a.append($("<option/>",{value:d,text:d}));c.val()==moment().month()&&a.find("[value='"+moment().date()+"']").attr("selected","selected");$.ReportDirector.ReloadReportGeneralOfCustomersData()},RefreshReportGeneralOfCustomersDataSummary:function(){var b=
$("#ReportGeneralOfCustomers_data"),d=$("#ReportGeneralOfCustomers_total"),c=$("#ReportGeneralOfCustomers_fixedWrapBody");$(b).find("tfoot td div").html(0);$(d).find("tbody td, tfoot td").html(0);$(c).find("tbody td, tfoot td").html(0);$(b).find("tbody .mail").each(function(){var a=$(this).attr("id-site"),a=$("#gc_foot_mail_"+a);a.html(parseFloat(a.html())+parseFloat($(this).find("div").html()));a=$(this).attr("id-customer");a=$("#gc_total_"+a).find("td:eq(0)");a.html(parseFloat(a.html())+parseFloat($(this).find("div").html()))});
$(b).find("tbody .chat").each(function(){var a=$(this).attr("id-site"),a=$("#gc_foot_chat_"+a);a.html(parseFloat(a.html())+parseFloat($(this).find("div").html()));var a=$(this).attr("id-customer"),c=$("#gc_total_"+a),d=c.find("td:eq(0)"),b=c.find("td:eq(1)"),c=c.find("td:eq(2)");b.html(parseFloat(b.html())+parseFloat($(this).find("div").html()));c.html(parseFloat(b.html())+parseFloat(d.html()));$("#gc_slide_total_"+a).find("td").html(c.html())});var b=$(d).find("tfoot>tr"),a=b.find("td:eq(0)"),h=
b.find("td:eq(1)"),e=b.find("td:eq(2)");$(d).find("tbody>tr").each(function(){a.html(parseFloat(a.html())+parseFloat($(this).find("td:eq(0)").html()));h.html(parseFloat(h.html())+parseFloat($(this).find("td:eq(1)").html()));e.html(parseFloat(e.html())+parseFloat($(this).find("td:eq(2)").html()))});$(c).find("tfoot>tr>td").html(e.html())},ReloadReportOverallSalary:function(b){b=b||$("#overlaySalarySite").find("input:radio:checked").val();var d=$("#ReportOverallSalary_data").find(">tbody");d.empty();
b={SiteID:b,year:$("#overlay-salary-year").data("DateTimePicker").date().year(),month:$("#overlay-salary-month").val()};$.post(BaseUrl+"reports/overlay/salary/data",b,function(c){c.status?($.tmpl("reportOverallSalaryTemplate",c.records).appendTo(d),$.ReportDirector.RefreshReportOverallSalaryDataSummary()):alert("\u041e\u0448\u0438\u0431\u043a\u0430 \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u044f \u0434\u0430\u043d\u043d\u044b\u0445")},"json")},RefreshReportOverallSalaryDataSummary:function(){var b=
$("#ReportOverallSalary_data");$(b).find("tr").find("td:eq(9)").html(0);$(b).find("tbody>tr").each(function(){var c=parseFloat($(this).find("td:eq(2) div").html())||0,a=parseFloat($(this).find("td:eq(4) div").html())||0,b=parseFloat($(this).find("td:eq(6) div").html())||0,d=parseFloat($(this).find("td:eq(8) div").html())||0;$(this).find("td:eq(9)").html((c+a+b+d).toFixed(2))});var d=$(b).find("tfoot td:eq(9)");$(b).find("tbody>tr").find("td:eq(9)").each(function(){var c=parseFloat($(this).html())||
0,a=parseFloat(d.html())||0;d.html((a+c).toFixed(2))})},ReloadReportGeneralSalary:function(){$("#ReportGeneralSalary_data").find("thead tr[id-employee] td[id-site] div").empty();$("#ReportGeneralSalary_data").find("tbody tr[id-employee] td[id-site]").empty().removeClass("repay");var b={year:$("#general-salary-year").data("DateTimePicker").date().year(),month:$("#general-salary-month").val()};$.post(BaseUrl+"reports/general/salary/data",b,function(b){b.status?($("#ReportGeneralSalary_data tbody tr[id-employee] td[id-site]").html("-"),
$(b.cross).each(function(c,a){$('#ReportGeneralSalary_data tbody tr[id-employee="'+a.EmployeeID+'"] td[id-site="'+a.SiteID+'"]').html("")}),$(b.records).each(function(c,a){if(0<a.EmployeeID){var b='#ReportGeneralSalary_data tbody tr[id-employee="'+a.EmployeeID+'"] td[id-site="'+a.SiteID+'"]';1==a.paid&&$(b).closest("td").addClass("repay");$.tmpl("reportGeneralSalarySumTemplate",a).appendTo(b)}else $('#ReportGeneralSalary_data thead tr[id-employee="'+a.EmployeeID+'"] td[id-site="'+a.SiteID+'"]').find("div").html(a.value)}),
$.ReportDirector.ReloadReportGeneralSalaryDataSummary()):alert("\u041e\u0448\u0438\u0431\u043a\u0430 \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u044f \u0434\u0430\u043d\u043d\u044b\u0445")},"json")},ReloadReportGeneralSalaryDataSummary:function(){$(".total-salary-report-table thead td[id-site]").each(function(){var c=$(this).attr("id-site"),a=parseFloat($(this).find("div").html())||0;$('.total-salary-report-table tbody td[id-site="'+c+'"]').each(function(){a-=parseFloat($(this).find("div>a").html())||
0});$('.total-salary-report-table tfoot td[id-site="'+c+'"]').html(a.toFixed(2))});$(".total-salary-report-table tbody tr").each(function(){var c=$(this).attr("id-employee"),a=0;$(this).find("td").each(function(){$(this).attr("id-site")&&(a+=parseFloat($(this).find("div>a").html())||0)});$("#pay_row_total_"+c).html(a.toFixed(2))});var b=0;$('.total-salary-report-table thead tr[id-employee="0"]').find("td.decimal").each(function(){$(this).attr("id-site")&&(b+=parseFloat($(this).find("div").html())||
0)});$("#pay_enter_total").html(b.toFixed(2));var d=0;$("#pay_total_row").find("td").each(function(){$(this).attr("id-site")&&(d+=parseFloat($(this).html())||0)});$("#pay_cell_rows_total").html(d.toFixed(2))},ReloadReportGeneralOfCustomers:function(){$.ReportDirector.ReloadGeneralOfCustomersMeta()},ReloadReportOverallAllocation:function(b){b=b||$("#overallAllocationSite").find("input:radio:checked").val();var d=$("#ReportOverallAllocation_data").find(">tbody");d.empty();$("#ReportOverallNotAllocation_data").find("td").empty();
$.post(BaseUrl+"reports/overall/allocation/data",{SiteID:b},function(c){c.status?($.tmpl("reportOverallAllocation_Template",c.records).appendTo(d),$("#ReportOverallNotAllocation_data").find("td").html(c.records.freeAllSitesCustomers)):alert("\u041e\u0448\u0438\u0431\u043a\u0430 \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u044f \u0434\u0430\u043d\u043d\u044b\u0445")},"json")},ReloadGeneralOfCustomersMeta:function(b){b=void 0===b?!1:b;var d={year:$("#general-customers-year").data("DateTimePicker").date().year(),
month:$("#general-customers-month").val(),day:$("#general-customers-day").val()};$("#ReportGeneralOfCustomers_data").empty();$("#ReportGeneralOfCustomers_fixedWrapBody").find(">tbody").empty();$("#ReportGeneralOfCustomers_total").find(">tbody").empty();$.getJSON(BaseUrl+"reports/general/customers/meta",d,function(c){c.status&&($.tmpl("reportGeneralOfCustomersTemplate",c.records).appendTo("#ReportGeneralOfCustomers_data"),$.tmpl("reportGeneralOfCustomers_fixedWrapBody_Template",c.records.customers).appendTo("#ReportGeneralOfCustomers_fixedWrapBody>tbody"),
$.tmpl("reportGeneralOfCustomers_total_Template",c.records.customers).appendTo("#ReportGeneralOfCustomers_total>tbody"),b||$.ReportDirector.RefreshReportGeneralOfCustomersDate())})},ReloadReportGeneralOfCustomersData:function(){var b={year:$("#general-customers-year").data("DateTimePicker").date().year(),month:$("#general-customers-month").val(),day:$("#general-customers-day").val()};$.post(BaseUrl+"reports/general/customers/data",b,function(b){function c(a,b,c,d,g){a.addClass(b).attr("id-customer",
c).attr("id-site",d).find("div").html(g||0)}$("#ReportGeneralOfCustomers_data").find(".mail div, .chat div").html(0);$.each(b.records,function(a,b){var d=b.CustomerID+"_"+b.SiteID;c($("#gc_mail_"+d),"mail",b.CustomerID,b.SiteID,b.emails);c($("#gc_chat_"+d),"chat",b.CustomerID,b.SiteID,b.chat)});$.ReportDirector.RefreshReportGeneralOfCustomersDataSummary()},"json")}};$.ReportDirector.Init()});
